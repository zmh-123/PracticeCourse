# SM4 算法软件实现与优化报告（后续AES-NI计划优化）

## 一、算法简介

**SM4**（商用密码算法4）是中国国家密码管理局发布的分组对称加密算法，广泛应用于国密标准。SM4 是一种 128 位分组、128 位密钥的分组密码，采用 32 轮 Feistel 结构，支持多种工作模式。

---

## 二、算法数学描述

### 1. 明文与密钥

- 明文分组 $M = (X_0, X_1, X_2, X_3) $，每个 $X_i $ 为 32 位无符号整数。
- 密钥 $K = (MK_0, MK_1, MK_2, MK_3) $，每个 $ MK_i $ 为 32 位无符号整数。

### 2. 轮密钥扩展

- 通过固定参数 $FK$ 和 $ CK $ 生成 32 轮密钥 $rk_0, rk_1, ..., rk_{31}$ 。
- 轮密钥扩展公式：
  $K_i = MK_i \oplus FK_i, \quad i=0,1,2,3$
  
  $$
  K_{i+4} = K_i \oplus L'(Sbox(K_{i+1} \oplus K_{i+2} \oplus K_{i+3} \oplus CK_i)), \quad i=0,...,31
  $$
  
  
  
  
  
  其中 $ L'(B) = B \oplus (B \lll 13) \oplus (B \lll 23) $，$ Sbox $ 为8比特S盒。

### 3. 加密/解密轮函数

- 32 轮迭代，每轮：
  $$
  X_{i+4} = X_i \oplus L(Sbox(X_{i+1} \oplus X_{i+2} \oplus X_{i+3} \oplus rk_i)), \quad i=0,...,31
  $$
  

  其中 $L(B) = B \oplus (B \lll 2) \oplus (B \lll 10) \oplus (B \lll 18) \oplus (B \lll 24) $。
  
- 最终输出 $ (X_{35}, X_{34}, X_{33}, X_{32}) $作为密文。

---

## 三、实现思路

### 1. 基础版实现

- 直接实现标准数学公式，逐字节S盒查找和移位操作。
- 优点：结构清晰，易于理解和验证。
- 缺点：效率较低。

### 2. T-table 优化实现

- 预先生成4个T表，将S盒查找和线性变换合并为查表操作，极大提升效率。
- 优点：大幅提升加解密速度，适合软件实现。
- 缺点：占用更多内存（4KB），但对现代计算机影响极小。

---

## 四、实验结果与性能对比

```text
基础版加密后密文: 681edf34d206965e86b3e94f536e4246
基础版解密后明文: 0123456789abcdeffedcba9876543210
T-table优化加密后密文: 681edf34d206965e86b3e94f536e4246
T-table优化解密后明文: 0123456789abcdeffedcba9876543210
===== 加解密效率对比（f4240轮）=====
基础版加密 f4240 次耗时: 1122.23 毫秒, 速度: 891085 块/秒
T-table优化加密 f4240 次耗时: 201.415 毫秒, 速度: 4.96487e+06 块/秒
基础版解密 f4240 次耗时: 1085.99 毫秒, 速度: 920818 块/秒
T-table优化解密 f4240 次耗时: 193.572 毫秒, 速度: 5.16604e+06 块/秒
```



| 算法         | 加密耗时(ms) | 加密速度(块/秒) | 解密耗时(ms) | 解密速度(块/秒) |
|--------------|-------------|-----------------|-------------|-----------------|
| 基础版       | 1122.23     | 891085          | 1085.99     | 920818          |
| T-table优化  | 201.415     | 4,964,870       | 193.572     | 5,166,040       |

- T-table优化比基础版快约5~6倍，极大提升了加解密效率。

---

## 五、后续优化计划

### 1. 指令集优化（AES-NI、GFNI、VPROLD等）

- **AES-NI**：虽然AES-NI是为AES设计的，但部分指令（如PSHUFB、PCLMULQDQ）可用于加速SM4的S盒查找和Galois域乘法。
- **GFNI**（Galois Field New Instructions）：Intel新一代指令集，专为$GF(2^8)$等有限域运算设计，可极大提升S盒和GCM乘法效率。
- **VPROLD**：AVX-512指令集中的循环移位指令，可高效实现SM4中的线性变换。
- **后续计划**：有时间将基于这些指令集实现SM4的SIMD并行加速，进一步提升加解密速度，达到OpenSSL等高性能库的水平。

### 2. 多核并行与批量加密

- 利用多线程/多核并行处理多个分组，提升吞吐量。
- 结合SIMD指令集实现批量加密（如一次处理4/8/16个分组）。

---

## 六、SM4-GCM 工作模式软件优化展望

### 1. GCM（Galois/Counter Mode）简介

- GCM是一种认证加密模式，结合了计数器模式（CTR）和Galois域乘法的消息认证码（GMAC）。
- 主要流程：分组加密（CTR模式）+ 认证标签生成（GHASH）。

### 2. SM4-GCM 实现思路

- **分组加密部分**：直接复用SM4的高效实现（如T-table或SIMD优化版），以CTR模式对明文分组加密。
- **认证部分（GHASH）**：核心为$GF(2^128)$上的乘法，可用PCLMULQDQ、GFNI等指令集加速。
- **优化方向**：
  - 预处理多组分组并行加密，提升吞吐量。
  - 利用SIMD指令集并行处理GHASH运算。
  - 针对Intel/AMD新指令集（如GFNI、AVX-512）做专门优化。
  - 设计高效的内存布局和流水线，减少缓存miss和分支预测失败。

### 3. 接下来的工作计划

- 实现SM4-GCM模式的完整软件库，支持高性能加解密与认证。
- 提供与OpenSSL等主流库兼容的接口，便于集成到实际工程。
- 针对不同平台（x86、ARM等）做适配和优化。

---
